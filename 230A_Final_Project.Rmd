---
title: "STAT 230A Final Project Code"
author: "Andrew Du"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
library(foreign)
library(knitr)
library(kableExtra)
library(sandwich)
library(haven)
library(lmtest)
library(MASS)
library(mfx)
library(prediction)
library(assertthat)
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
setwd('/Users/du/Documents/sp24/stat230a/final_project/wfh')
install.packages("/Users/du/Documents/sp24/stat230a/final_project/wfh/prediction_0.3.17.tar.gz", type = "source", repos = NULL)
install.packages("/Users/du/Documents/sp24/stat230a/final_project/wfh/margins_0.3.26.1.tar.gz", type = "source", repos = NULL)
library(prediction)
library(margins)
```

```{r}
library(devtools)
load_all("mfx")
```

## Table 1

Redoing analyses from table 1, but with logit regression and robust standard error for all

Original table:

```{r table 1}
summary_volunteer_data <- read.dta("data/summary_volunteer.dta")
summary_volunteer_data$children <- ifelse(summary_volunteer_data$children == "yes", 1.0, 0.0)
summary_volunteer_data$bedroom <- ifelse(summary_volunteer_data$bedroom == "yes", 1.0, 0.0)
summary_volunteer_data
```

```{r}
table_1_formulas <- list(
  volunteer ~ children, 
  volunteer ~ married, 
  volunteer ~ children + married + commute + bedroom, 
  volunteer ~ children + married + commute + bedroom + high_educ + tenure,
  volunteer ~ children + married + commute + bedroom + high_educ + tenure + grosswage,
  volunteer ~ grosswage,
  volunteer ~ children + married + commute + bedroom + high_educ + tenure + grosswage + age + men
  )

table_1_regressors <- c("age", "tenure", "grosswage", "children", "bedroom", "commute", "men", "married", "high_educ")
```

```{r}

compare_logit_probit_fit <- function(formula, data) {
  model_probit <- glm(formula, data=data, family=binomial(link="probit"))
  model_logit <- glm(formula, data=data, family=binomial(link="logit"))
  
  cat("probit model summary:", "\n")
  print(summary(model_probit))
  cat("logit model summary:", "\n")
  print(summary(model_logit))
}

compare_logit_probit <- function(formula, data, robust=FALSE, ehw_type="HC1") {
  model_probit <- probitmfx(formula, data=data, robust=robust, robust_type=ehw_type)
  model_logit <- logitmfx(formula, data=data, robust=robust, robust_type=ehw_type)
  
  if (robust) {
    cat("probit model average marginal effect with", ehw_type, "error:", "\n")
    print(model_probit$mfxest)
    cat("logit model average marginal effect with", ehw_type, "error:", "\n")
    print(model_logit$mfxest)
  } else {
    cat("probit model average marginal effect with standard error:", "\n")
    print(model_probit$mfxest)
    cat("logit model average marginal effect with standard error:", "\n")
    print(model_logit$mfxest)
  }
}

parse_significance <- function(p_val) {
  significance <- ifelse(p_val < 0.001, "***",
                         ifelse(p_val < 0.01, "**",
                                ifelse(p_val < 0.05, "*", "")))
  return(significance)
}

format_hci_results <- function(mfxest_se, mfxest_hc0, mfxest_hc1, regressors) {
  df_mfxest_se <- data.frame(mfxest_se)
  df_mfxest_hc0 <- data.frame(mfxest_hc0)
  df_mfxest_hc1 <- data.frame(mfxest_hc1)
  
  formatted <- data.frame(Info = vector("character", length(regressors)),
                          row.names=regressors,
                          stringsAsFactors=FALSE)

  for (feat in regressors) {
    if (feat %in% rownames(df_mfxest_se)) {
      signif_se <- parse_significance(df_mfxest_se[feat, "P..z."])
      signif_hc0 <- parse_significance(df_mfxest_hc0[feat, "P..z."])
      signif_hc1 <- parse_significance(df_mfxest_hc1[feat, "P..z."])
      
      assert_that(signif_se == signif_hc0 && signif_se == signif_hc1, msg="significance values are not the same!")
      
      se <- df_mfxest_se[feat, "Std..Err."]
      hc0 <- df_mfxest_hc0[feat, "Std..Err."]
      hc1 <- df_mfxest_hc1[feat, "Std..Err."]
    
      ame <- df_mfxest_se[feat, "dF.dx"]
      
      formatted[feat, "Info"] <- sprintf("%.3f \n (%.4f / %.4f / %.4f) %s", 
                                ame, se, hc0, hc1, signif_se)
      
      } else {
        formatted[feat, "Info"] <- ""
      }
  }
  
  return(formatted)
}

compare_hci_errors <- function(formula, data, parse=FALSE, regressors=NULL) {
  model_probit_se <- probitmfx(formula, data=data, robust=FALSE)
  model_probit_hc0 <- probitmfx(formula, data=data, robust=TRUE, robust_type="HC0")
  model_probit_hc1 <- probitmfx(formula, data=data, robust=TRUE, robust_type="HC1")
  
  cat("probit model with standard errors:", "\n")
  print(model_probit_se$mfxest)
  cat("probit model with hc0 correction:", "\n")
  print(model_probit_hc0$mfxest)
  cat("probit model with hc1 correction:", "\n")
  print(model_probit_hc1$mfxest)
  
  if (parse && !is.null(regressors)) {
    results <- format_hci_results(model_probit_se$mfxest, 
                                         model_probit_hc0$mfxest, 
                                         model_probit_hc1$mfxest,
                                         regressors)
    return(results)
  }
}
```

```{r}
dummy <- table_1_formulas[[4]]
model_probit_se_dummy <- probitmfx(dummy, data=summary_volunteer_data, robust=FALSE)
print(colnames(data.frame(model_probit_se_dummy$mfxest)))
data.frame(model_probit_se_dummy$mfxest)['children', 'P..z.']
```

```{r}
df_table <- data.frame(row.names=table_1_regressors)
for (f in table_1_formulas) {
  #compare_hci_errors(f, data=summary_volunteer_data, 
  #                   parse=TRUE, 
  #                   regressors=table_1_regressors)
  df_table <- cbind(df_table, compare_hci_errors(f, data=summary_volunteer_data, parse=TRUE, 
                     regressors=table_1_regressors))
  #print(compare_hci_errors(f, data=summary_volunteer_data, parse=TRUE, 
  #                   regressors=table_1_regressors))
  #cat("\n")
}
print(df_table)
```

```{r}

formula <- volunteer ~ children + married + commute + bedroom

compare_logit_probit(formula, data = summary_volunteer_data, robust=TRUE, ehw_type="HC0")

cat("\n")

compare_logit_probit(formula, data = summary_volunteer_data, robust=TRUE, ehw_type="HC1")

cat("\n")

compare_logit_probit_fit(formula, data=summary_volunteer_data)
```

```{r}
for (f in table_1_formulas) {
  print(f)
}
```

```{r}

# Column (1): dprobit volunteer children
model1 <- glm(volunteer ~ children, data = summary_volunteer_data, family = binomial(link = "probit"))
model1_logistic <- glm(volunteer ~ children, data = summary_volunteer_data, family = binomial(link = "logit"))
model1_mfx <- probitmfx(volunteer ~ children, data = summary_volunteer_data, robust=TRUE)
model1_mfx_hc1 <- probitmfx(volunteer ~ children, data = summary_volunteer_data, robust=TRUE, robust_type="HC1")
model1_mfx_nonrob <- probitmfx(volunteer ~ children, data = summary_volunteer_data, robust=FALSE)

# Column (2): dprobit volunteer married
model2 <- glm(volunteer ~ married, data = summary_volunteer_data, family = binomial(link = "probit"))

# Column (3): dprobit volunteer children married commute bedroom
model3 <- glm(volunteer ~ children + married + commute + bedroom, data = summary_volunteer_data, family = binomial(link = "probit"))

# Column (4): dprobit volunteer children married commute bedroom high_educ tenure
model4 <- glm(volunteer ~ children + married + commute + bedroom + high_educ + tenure, data = summary_volunteer_data, family = binomial(link = "probit"))

# Column (5): dprobit volunteer children married commute bedroom high_educ tenure grosswage
model5 <- glm(volunteer ~ children + married + commute + bedroom + high_educ + tenure + grosswage, data = summary_volunteer_data, family = binomial(link = "probit"))

# Column (6): dprobit volunteer grosswage
model6 <- glm(volunteer ~ grosswage, data = summary_volunteer_data, family = binomial(link = "probit"))

# Column (7): dprobit volunteer children married commute bedroom high_educ tenure grosswage age men
model7 <- glm(volunteer ~ children + married + commute + bedroom + high_educ + tenure + grosswage + age + men, data = summary_volunteer_data, family = binomial(link = "probit"))

print(coeftest(model1, vcov = vcovHC(model1, type="HC1")))

print(coeftest(model1_logistic, vcov = vcovHC(model1, type="HC1")))

marginal_effects <- margins(model1)
#print(marginal_effects)
print(model1_mfx$mfxest)
print(model1_mfx_hc1$mfxest)
print(model1_mfx_nonrob$mfxest)

print(coeftest(model2, vcov = vcovHC(model2, type="HC1")))
print(coeftest(model3, vcov = vcovHC(model3, type="HC1")))
print(coeftest(model4, vcov = vcovHC(model4, type="HC1")))
print(coeftest(model5, vcov = vcovHC(model5, type="HC1")))
print(coeftest(model6, vcov = vcovHC(model6, type="HC1")))
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
